#!/bin/bash

# Script para configurar secrets do Gabi na VPS
# Gera senhas seguras e configura arquivos de secrets

set -e

echo "游댏 Configurando secrets do Gabi..."

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fun칞칚o para log
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Fun칞칚o para gerar senha segura
generate_password() {
    openssl rand -base64 32 | tr -d "=+/" | cut -c1-25
}

# Verificar se openssl est치 dispon칤vel
if ! command -v openssl &> /dev/null; then
    error "OpenSSL n칚o est치 instalado. Execute: sudo apt-get install openssl"
fi

# Criar diret칩rio secrets se n칚o existir
mkdir -p secrets

log "Gerando senhas seguras..."

# Gerar senha do PostgreSQL
POSTGRES_PASSWORD=$(generate_password)
echo "$POSTGRES_PASSWORD" > secrets/POSTGRES_PASSWORD
chmod 600 secrets/POSTGRES_PASSWORD
success "Senha do PostgreSQL gerada"

# Gerar chave de seguran칞a do OS
OS_SECURITY_KEY=$(generate_password)
echo "$OS_SECURITY_KEY" > secrets/OS_SECURITY_KEY
chmod 600 secrets/OS_SECURITY_KEY
success "Chave de seguran칞a do OS gerada"

# Configurar OpenAI API Key
log "Configurando OpenAI API Key..."
echo "Por favor, insira sua OpenAI API Key:"
read -s OPENAI_API_KEY
echo "$OPENAI_API_KEY" > secrets/OPENAI_API_KEY
chmod 600 secrets/OPENAI_API_KEY
success "OpenAI API Key configurada"

# Verificar se .env existe
if [ ! -f ".env" ]; then
    log "Criando arquivo .env..."
    cp .env.example .env
    success "Arquivo .env criado"
fi

# Atualizar .env com as senhas geradas
log "Atualizando arquivo .env..."
sed -i "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=$POSTGRES_PASSWORD/" .env
sed -i "s/OS_SECURITY_KEY=.*/OS_SECURITY_KEY=$OS_SECURITY_KEY/" .env

# Verificar se DOMAIN_ROOT est치 configurado
if ! grep -q "DOMAIN_ROOT=" .env; then
    log "Configurando dom칤nio..."
    echo "DOMAIN_ROOT=gabi.ness.tec.br" >> .env
    success "Dom칤nio configurado: gabi.ness.tec.br"
fi

# Verificar se ACME_EMAIL est치 configurado
if ! grep -q "ACME_EMAIL=" .env; then
    log "Configurando email para certificados SSL..."
    echo "Por favor, insira seu email para certificados SSL:"
    read ACME_EMAIL
    echo "ACME_EMAIL=$ACME_EMAIL" >> .env
    success "Email para certificados SSL configurado"
fi

log "Secrets configurados com sucesso!"
log "Arquivos criados:"
log "  - secrets/POSTGRES_PASSWORD"
log "  - secrets/OS_SECURITY_KEY"
log "  - secrets/OPENAI_API_KEY"
log "  - .env (atualizado)"

warning "IMPORTANTE: Mantenha estes arquivos seguros e fa칞a backup!"
warning "Nunca commite estes arquivos no Git!"

success "Setup dos secrets conclu칤do!"
