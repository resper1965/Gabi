# üöÄ Deploy em Produ√ß√£o - Gabi Multitenancy

Este guia explica como fazer o deploy do sistema Gabi Multitenancy em ambiente de produ√ß√£o.

## üìã Pr√©-requisitos

### Sistema
- **Ubuntu 20.04+** ou **CentOS 8+**
- **Docker 20.10+**
- **Docker Compose 2.0+**
- **4GB RAM** m√≠nimo (8GB recomendado)
- **20GB** espa√ßo em disco
- **Dom√≠nio** configurado com DNS

### APIs Necess√°rias
- **OpenAI API Key** (GPT-4o recomendado)
- **Anthropic API Key** (opcional)
- **Dom√≠nio** com DNS configurado

## üîß Configura√ß√£o Inicial

### 1. Clonar o Reposit√≥rio
```bash
git clone <repository-url>
cd gabi-infra
```

### 2. Configurar Vari√°veis de Ambiente
```bash
# Copiar arquivo de exemplo
cp env.production.example .env

# Editar configura√ß√µes
nano .env
```

**Configura√ß√µes obrigat√≥rias:**
```bash
# Dom√≠nio principal
DOMAIN=gabi.yourdomain.com

# Banco de dados (senhas seguras)
DB_PASSWORD=gabi_prod_2024_secure_password
REDIS_PASSWORD=gabi_redis_prod_2024_secure_password

# APIs de IA
OPENAI_API_KEY=sk-your-openai-key-here
ANTHROPIC_API_KEY=sk-ant-your-anthropic-key-here

# SSL/TLS
ACME_EMAIL=admin@yourdomain.com
```

### 3. Configurar DNS
Configure os seguintes registros DNS:
```
A    gabi.yourdomain.com    -> IP_DO_SERVIDOR
A    *.gabi.yourdomain.com  -> IP_DO_SERVIDOR
```

## üöÄ Deploy Autom√°tico

### Deploy Completo
```bash
# Executar script de deploy
./scripts/deploy-prod.sh
```

O script ir√°:
- ‚úÖ Verificar pr√©-requisitos
- ‚úÖ Parar containers existentes
- ‚úÖ Construir imagens Docker
- ‚úÖ Iniciar todos os servi√ßos
- ‚úÖ Verificar sa√∫de dos servi√ßos
- ‚úÖ Configurar SSL autom√°tico

### Deploy Manual
```bash
# Parar servi√ßos existentes
docker-compose -f docker-compose.prod.yml down

# Construir imagens
docker-compose -f docker-compose.prod.yml build

# Iniciar servi√ßos
docker-compose -f docker-compose.prod.yml up -d

# Verificar status
docker-compose -f docker-compose.prod.yml ps
```

## üìä Monitoramento

### Verificar Status
```bash
# Monitoramento completo
./scripts/monitor-prod.sh

# Status dos containers
docker-compose -f docker-compose.prod.yml ps

# Logs em tempo real
docker-compose -f docker-compose.prod.yml logs -f

# Logs de um servi√ßo espec√≠fico
docker-compose -f docker-compose.prod.yml logs -f gabi-chat
```

### URLs de Acesso
- **Gabi Chat**: `https://gabi.yourdomain.com`
- **Gabi OS API**: `https://gabi.yourdomain.com/os`
- **Gabi Ingest API**: `https://gabi.yourdomain.com/ingest`
- **Traefik Dashboard**: `https://gabi.yourdomain.com:8080`

## üíæ Backup e Restaura√ß√£o

### Backup Autom√°tico
```bash
# Fazer backup completo
./scripts/backup-prod.sh
```

### Backup Manual
```bash
# Backup do banco
docker-compose -f docker-compose.prod.yml exec db pg_dump -U gabi -d gabi_prod > backup.sql

# Backup do Redis
docker-compose -f docker-compose.prod.yml exec redis redis-cli -a $REDIS_PASSWORD --rdb /data/dump.rdb
```

### Restaura√ß√£o
```bash
# Restaurar banco
docker-compose -f docker-compose.prod.yml exec -T db psql -U gabi -d gabi_prod < backup.sql

# Restaurar Redis
docker cp backup.rdb gabi-redis-prod:/data/dump.rdb
```

## üîß Manuten√ß√£o

### Atualiza√ß√µes
```bash
# Parar servi√ßos
docker-compose -f docker-compose.prod.yml down

# Atualizar c√≥digo
git pull origin main

# Reconstruir e reiniciar
docker-compose -f docker-compose.prod.yml build --no-cache
docker-compose -f docker-compose.prod.yml up -d
```

### Limpeza
```bash
# Limpar imagens antigas
docker system prune -f

# Limpar volumes n√£o utilizados
docker volume prune -f
```

### Logs
```bash
# Ver logs de todos os servi√ßos
docker-compose -f docker-compose.prod.yml logs

# Ver logs de um servi√ßo espec√≠fico
docker-compose -f docker-compose.prod.yml logs gabi-chat

# Ver logs em tempo real
docker-compose -f docker-compose.prod.yml logs -f
```

## üõ°Ô∏è Seguran√ßa

### Firewall
```bash
# Configurar firewall (Ubuntu)
ufw allow 80
ufw allow 443
ufw allow 22
ufw enable
```

### SSL/TLS
- **Let's Encrypt** configurado automaticamente
- **Certificados** renovados automaticamente
- **HTTPS** obrigat√≥rio para produ√ß√£o

### Senhas Seguras
- Use senhas **fortes** para banco e Redis
- Configure **chaves de API** v√°lidas
- Mantenha **backups** regulares

## üìà Performance

### Recursos Recomendados
- **CPU**: 4 cores m√≠nimo
- **RAM**: 8GB m√≠nimo (16GB recomendado)
- **Disco**: 50GB SSD
- **Rede**: 100Mbps m√≠nimo

### Otimiza√ß√µes
- **Redis** para cache
- **PostgreSQL** otimizado
- **Docker** com recursos limitados
- **Traefik** com load balancing

## üö® Troubleshooting

### Problemas Comuns

#### Servi√ßo n√£o inicia
```bash
# Verificar logs
docker-compose -f docker-compose.prod.yml logs [servi√ßo]

# Verificar recursos
docker stats
```

#### SSL n√£o funciona
```bash
# Verificar certificados
docker-compose -f docker-compose.prod.yml logs traefik

# Verificar DNS
nslookup gabi.yourdomain.com
```

#### Banco de dados n√£o conecta
```bash
# Verificar status do banco
docker-compose -f docker-compose.prod.yml exec db pg_isready -U gabi

# Verificar logs do banco
docker-compose -f docker-compose.prod.yml logs db
```

### Comandos √öteis
```bash
# Reiniciar um servi√ßo
docker-compose -f docker-compose.prod.yml restart [servi√ßo]

# Ver status detalhado
docker-compose -f docker-compose.prod.yml ps -a

# Entrar em um container
docker-compose -f docker-compose.prod.yml exec [servi√ßo] bash
```

## üìû Suporte

### Logs Importantes
- **Gabi Chat**: `docker-compose -f docker-compose.prod.yml logs gabi-chat`
- **Gabi OS**: `docker-compose -f docker-compose.prod.yml logs gabi-os`
- **Traefik**: `docker-compose -f docker-compose.prod.yml logs traefik`

### Informa√ß√µes do Sistema
```bash
# Vers√£o do Docker
docker --version

# Informa√ß√µes do sistema
uname -a

# Espa√ßo em disco
df -h

# Uso de mem√≥ria
free -h
```

## ‚úÖ Checklist de Deploy

- [ ] Docker e Docker Compose instalados
- [ ] Dom√≠nio configurado no DNS
- [ ] Arquivo `.env` configurado
- [ ] Chaves de API v√°lidas
- [ ] Firewall configurado
- [ ] Backup configurado
- [ ] Monitoramento ativo
- [ ] SSL funcionando
- [ ] Todos os servi√ßos saud√°veis

---

**üéØ Sistema Gabi Multitenancy em Produ√ß√£o!**

Para mais informa√ß√µes, consulte a documenta√ß√£o completa em `docs/`.
