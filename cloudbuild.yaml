steps:
  # ── Build API ──
  - id: "build-api"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-api:${_TAG}"
      - "-t"
      - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-api:latest"
      - "./api"

  # ── Build Web (monorepo — context from root) ──
  - id: "build-web"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-f"
      - "web/Dockerfile"
      - "-t"
      - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-web:${_TAG}"
      - "-t"
      - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-web:latest"
      - "--build-arg"
      - "NEXT_PUBLIC_API_URL=${_API_URL}"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_API_KEY=${_FIREBASE_API_KEY}"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${_FIREBASE_AUTH_DOMAIN}"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${_FIREBASE_PROJECT_ID}"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${_FIREBASE_PROJECT_ID}.firebasestorage.app"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=661727503610"
      - "--build-arg"
      - "NEXT_PUBLIC_FIREBASE_APP_ID=1:661727503610:web:3762934ab7daca293d1543"
      - "."
    waitFor: ["-"] # parallel with api build

  # ── Push Images ──
  - id: "push-api"
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "--all-tags",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-api",
      ]
    waitFor: ["build-api"]

  - id: "push-web"
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "--all-tags",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-web",
      ]
    waitFor: ["build-web"]

  # ── Deploy API to Cloud Run ──
  - id: "deploy-api"
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud run deploy gabi-api \
          --image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-api:${_TAG} \
          --region=${_REGION} \
          --platform=managed \
          --memory=1Gi --cpu=1 \
          --min-instances=0 --max-instances=3 \
          --port=8080 \
          --add-cloudsql-instances=${PROJECT_ID}:${_REGION}:gabi-db \
          --set-env-vars="^##^GABI_GCP_PROJECT_ID=${PROJECT_ID}##GABI_VERTEX_AI_LOCATION=${_REGION}##GABI_FIREBASE_PROJECT_ID=${_FIREBASE_PROJECT_ID}##GABI_CORS_ORIGINS=[\"https://gabi.ness.com.br\",\"https://gabi-web-935866797303.us-central1.run.app\",\"http://localhost:3000\"]##GABI_ADMIN_EMAILS=[\"resper@ness.com.br\",\"resper@bekaa.eu\"]##GABI_AUTO_APPROVE_DOMAINS=[\"ness.com.br\",\"bekaa.eu\"]##PYTHONPATH=/app" \
          --set-secrets="GABI_DATABASE_URL=GABI_DATABASE_URL:latest"
    waitFor: ["push-api"]

  # ── Deploy Web to Cloud Run ──
  - id: "deploy-web"
    name: "gcr.io/cloud-builders/gcloud"
    args:
      - "run"
      - "deploy"
      - "gabi-web"
      - "--image=${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO}/gabi-web:${_TAG}"
      - "--region=${_REGION}"
      - "--platform=managed"
      - "--memory=512Mi"
      - "--cpu=1"
      - "--min-instances=0"
      - "--max-instances=3"
      - "--port=3000"
    waitFor: ["push-web"]

substitutions:
  _REGION: us-central1
  _REPO: gabi
  _TAG: latest
  _API_URL: https://gabi-api-935866797303.us-central1.run.app
  _FIREBASE_API_KEY: "AIzaSyD33o0h2hlMp7izg7oMdB-PbEBrZW_e4o8"
  _FIREBASE_AUTH_DOMAIN: "ngabi-480613.firebaseapp.com"
  _FIREBASE_PROJECT_ID: "ngabi-480613"

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8

timeout: 1800s
